name: Test
permissions: {}

on:
  workflow_call:
    inputs:
      node-versions:
        required: false
        type: string
        default: '[20,22,24,25]'

      typecheck:
        required: false
        type: string
        default: nr typecheck

      lint:
        required: false
        type: string
        default: nr lint

      build:
        required: false
        type: string
        default: nr build

      test:
        required: false
        type: string
        default: nr test

      skip-lint:
        required: false
        type: boolean
        default: false

      skip-test:
        required: false
        type: boolean
        default: false

jobs:
  lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: ${{ !inputs.skip-lint }}
    steps:
      - name: Setup repo
        uses: nicksp/workflows/.github/actions/setup-repo@757f0794d25ac6a6d484c0740ad5ef8638f768f2 # v1
      - name: Build
        run: ${{ inputs.build }}
        if: inputs.build != ''
      - name: Lint
        run: ${{ inputs.lint }}
        if: inputs.lint != ''
      - name: Typecheck
        run: ${{ inputs.typecheck }}
        if: inputs.typecheck != ''

  test:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    if: ${{ !inputs.skip-test }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node: ${{ fromJson(inputs.node-versions) }}
      fail-fast: false

    steps:
      - name: Setup repo
        uses: nicksp/workflows/.github/actions/setup-repo@757f0794d25ac6a6d484c0740ad5ef8638f768f2 # v1
        with:
          node-version: ${{ matrix.node }}
      - name: Build
        run: ${{ inputs.build }}
        if: inputs.build != ''
      - name: Test
        run: ${{ inputs.test }}
